<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŸãƒ‹å¤§å¯Œè±ª - ä¿®æ­£å®Œäº†ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a4a2e; --card-white: #fdfdfd; }
        body { font-family: sans-serif; text-align: center; background: var(--bg-color); color: white; margin: 0; padding: 20px; overflow-x: hidden; }
        .card { 
            display: inline-block; width: 65px; height: 95px; 
            background: var(--card-white); color: #333;
            border-radius: 8px; margin: 5px; line-height: 95px; 
            font-size: 24px; font-weight: bold; border: 2px solid #000;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer;
        }
        .screen { display: none; }
        .active { display: block; }
        #table-card { transform: scale(1.2); background: #ffeb3b; margin: 20px auto; }
        .turn-highlight { border: 4px solid #f1c40f; box-shadow: 0 0 20px #f1c40f; }
        button { padding: 12px 24px; font-size: 16px; border-radius: 5px; border: none; background: #e67e22; color: white; cursor: pointer; margin-top: 10px; }
        #timer-display { font-size: 20px; color: #ff6b6b; font-weight: bold; height: 30px; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>ğŸƒ ãƒŸãƒ‹å¤§å¯Œè±ª</h1>
        <input type="text" id="user-name" placeholder="åå‰" style="padding:10px; font-size:18px;"><br>
        <button onclick="checkRole()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>

    <div id="wait-screen" class="screen">
        <h2 id="wait-msg">æ¥ç¶šä¸­...</h2>
        <div id="qr-area"></div>
        <p id="player-list">å‚åŠ è€…: å¾…æ©Ÿä¸­...</p>
        <button id="start-btn" style="display:none;" onclick="startGame()">å…¨å“¡æƒã£ãŸï¼é–‹å§‹</button>
    </div>

    <div id="play-screen" class="screen">
        <div id="timer-display"></div>
        <p>ã€å ´ã®ã‚«ãƒ¼ãƒ‰ã€‘</p>
        <div id="table-card" class="card">ãƒ¼</div>
        <div id="turn-info" style="margin:10px; font-weight:bold;"></div>
        <hr>
        <div id="my-hand"></div>
        <br>
        <button id="pass-btn" onclick="passTurn()">ãƒ‘ã‚¹ã™ã‚‹</button>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ‰ å„ªå‹ ğŸ‰</h1>
        <div id="winner-name" style="font-size:40px; color:gold;"></div>
        <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <button onclick="adminReset()" style="position:fixed; bottom:5px; right:5px; opacity:0.3; font-size:10px; background:#000; color:#fff;">ç®¡ç†è€…ãƒªã‚»ãƒƒãƒˆ</button>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAa1CZBgLYViSMKhg-9D33EZUQwXENFwzo",
            authDomain: "game-496d3.firebaseapp.com",
            projectId: "game-496d3",
            storageBucket: "game-496d3.firebasestorage.app",
            messagingSenderId: "32461027881",
            appId: "1:32461027881:web:06b438a0e2924a2e6b7a38",
            measurementId: "G-HRFJXD28LB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const roomRef = db.ref('mini_daifugo/game');

        let myId = Math.random().toString(32).substring(2);
        let myName = "";
        let isHost = false;
        let inactivityTimer, kickTimer;

        // æ•°å­—ã‚’å¤§å¯Œè±ªã®å¼·ã•ã«å¤‰æ›ã™ã‚‹
        function getRank(num) {
            if (num === 0) return 0;  // å ´ãŒç©ºã®å ´åˆ
            if (num === 1) return 14; // Aã¯13(K)ã‚ˆã‚Šå¼·ã„
            if (num === 2) return 15; // 2ã¯æœ€å¼·
            return num;               // 3ã€œ13ã¯ãã®ã¾ã¾ã®æ•°å­—
        }

        async function checkRole() {
            myName = document.getElementById('user-name').value || "ãªãªã—";
            const snap = await roomRef.get();
            const data = snap.val();

            if (!data || data.state === 'finished' || !data.state) {
                isHost = true;
                await roomRef.set({ 
                    state: 'waiting', tableCard: 0, winners: "", 
                    lastUpdate: Date.now(), players: {} 
                });
                new QRCode(document.getElementById("qr-area"), window.location.href);
                document.getElementById('start-btn').style.display = "inline-block";
                document.getElementById('wait-msg').innerText = "ã‚ãªãŸã¯ã€è¦ªæ©Ÿã€‘ã§ã™";
            } else {
                isHost = false;
                document.getElementById('wait-msg').innerText = "ã€å­æ©Ÿã€‘ã¨ã—ã¦å‚åŠ ä¸­...";
            }
            joinGame();
        }

        function joinGame() {
            roomRef.child('players').child(myId).set({ name: myName, hand: [0] });
            roomRef.child('players').child(myId).onDisconnect().remove();

            // ã‚‚ã—è‡ªåˆ†ãŒã€Œè¦ªã€ãªã‚‰ã€æ¥ç¶šãŒåˆ‡ã‚ŒãŸã‚‰éƒ¨å±‹å…¨ä½“ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            if (isHost) {
                roomRef.onDisconnect().remove();
            }
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('wait-screen').classList.add('active');

            roomRef.on('value', (snap) => {
                const data = snap.val();
                if (!data) return;
                
                const pKeys = Object.keys(data.players || {});
                document.getElementById('player-list').innerText = "å‚åŠ è€…: " + pKeys.map(k => data.players[k].name).join(", ");

                if (data.state === 'playing') showPlayScreen(data);
                if (data.state === 'finished') showResultScreen(data.winners);
            });
        }

        function startGame() {
            roomRef.child('players').once('value', (snap) => {
                const players = snap.val();
                const ids = Object.keys(players);
                
                let deck = [];
                for (let i = 1; i <= 13; i++) {
                    for (let j = 0; j < 4; j++) deck.push(i);
                }
                
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }

                ids.forEach((id) => {
                    let hand = deck.splice(0, 6);
                    hand.sort((a, b) => a - b);
                    roomRef.child('players').child(id).update({ hand: hand });
                });

                // âœ… ä¿®æ­£ï¼šnum ã‚„ nextId ã§ã¯ãªãã€åˆæœŸå€¤ã‚’è¨­å®š
                roomRef.update({ 
                    state: 'playing',
                    tableCard: 0, 
                    turnPlayer: ids[0],
                    lastShooter: "" 
                });
            });
        }

        function showPlayScreen(data) {
            document.getElementById('wait-screen').classList.remove('active');
            document.getElementById('play-screen').classList.add('active');
            const top = data.tableCard || 0;
            const displayTop = (top === 1) ? 'A' : (top === 11) ? 'J' : (top === 12) ? 'Q' : (top === 13) ? 'K' : (top === 0) ? 'ãƒ¼' : top;
            document.getElementById('table-card').innerText = displayTop;
            
            const isMyTurn = (data.turnPlayer === myId);
            document.getElementById('turn-info').innerText = isMyTurn ? "â˜… ã‚ãªãŸã®ç•ªã§ã™ â˜…" : `${data.players[data.turnPlayer]?.name}ã•ã‚“ã®ç•ªã§ã™`;
            document.getElementById('pass-btn').disabled = !isMyTurn;

            if (isMyTurn) {
                startTurnTimer();
            } else {
                stopTurnTimer();
            }

            // æ‰‹æœ­ã®è¡¨ç¤º
            const myData = data.players[myId];
            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = "";
            
            if (myData && myData.hand) {
                const top = data.tableCard || 0; // ç¾åœ¨ã®å ´ã®ã‚«ãƒ¼ãƒ‰ã‚’å–å¾—

                myData.hand.forEach((num, idx) => {
                    const c = document.createElement('div');
                    
                    // --- å‡ºã›ã‚‹ã‹ã©ã†ã‹åˆ¤å®š ---
                    let canPlayThisCard = false;
                    if (isMyTurn) {
                        const myRank = getRank(num);
                        const topRank = getRank(top);
                        
                        if (top === 0) canPlayThisCard = true; // å ´ãŒç©º
                        else if (top === 2 && num === 3) canPlayThisCard = true; // ä¸‹å…‹ä¸Š
                        else if (top !== 2 && myRank > topRank) canPlayThisCard = true; // é€šå¸¸ã®å¼·ã•æ¯”è¼ƒ
                    }

                    // --- å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ã ã‘ turn-highlight ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹ ---
                    c.className = 'card' + (canPlayThisCard ? ' turn-highlight' : '');
                    
                    // è¡¨ç¤ºç”¨ã®å¤‰æ› (A, J, Q, K)
                    const displayNum = (num === 1) ? 'A' : (num === 11) ? 'J' : (num === 12) ? 'Q' : (num === 13) ? 'K' : num;
                    c.innerText = displayNum;
                    
                    c.onclick = () => isMyTurn && playCard(num, idx, myData.hand);
                    handDiv.appendChild(c);
                });
            }
        }

        function playCard(num, idx, hand) {
            roomRef.once('value', (snap) => {
                const data = snap.val();
                const top = data.tableCard || 0; // å ´ã®ã‚«ãƒ¼ãƒ‰
                let canPlay = false;

                const myRank = getRank(num);
                const topRank = getRank(top);

                // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã‹ã‚‰ ---
                if (top === 0) {
                    // 1. å ´ãŒç©ºãªã‚‰ä½•ã§ã‚‚å‡ºã›ã‚‹
                    canPlay = true;
                } else if (top === 2 && num === 3) {
                    // 2. ã€ä¸‹å…‹ä¸Šã€‘å ´ãŒ 2 ã§ã€è‡ªåˆ†ãŒå‡ºã™ã®ãŒ 3 ãªã‚‰å‹ã¦ã‚‹ï¼
                    canPlay = true;
                    console.log("ä¸‹å…‹ä¸ŠæˆåŠŸï¼");
                } else if (top === 2) {
                    // 3. å ´ãŒ 2 ã®æ™‚ã€3 ä»¥å¤–ã¯çµ¶å¯¾ã«å‡ºã›ãªã„ï¼ˆ2ã‚ˆã‚Šå¼·ã„ãƒ©ãƒ³ã‚¯ã¯å­˜åœ¨ã—ãªã„ãŸã‚ï¼‰
                    canPlay = false;
                } else if (myRank > topRank) {
                    // 4. é€šå¸¸ãƒ«ãƒ¼ãƒ«ï¼šå ´ã‚ˆã‚Šå¼·ã‘ã‚Œã°å‡ºã›ã‚‹
                    canPlay = true;
                }
                // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ ---

                if (canPlay) {
                    // ï¼ˆä»¥ä¸‹ã€ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™å‡¦ç†ï¼šä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰
                    stopTurnTimer();
                    const nextId = getNextPlayerId(data.players, myId);
                    hand.splice(idx, 1);
                    
                    roomRef.update({ 
                        tableCard: num, 
                        turnPlayer: nextId,
                        lastShooter: myId 
                    });
                    roomRef.child('players').child(myId).update({ hand: hand });
                    
                    if (hand.length === 0) {
                        roomRef.update({ state: 'finished', winners: myName });
                    }
                } else {
                    alert("ãã®ã‚«ãƒ¼ãƒ‰ã¯å‡ºã›ã¾ã›ã‚“ï¼");
                }
            });
        }

        function passTurn() {
            roomRef.once('value', (snap) => {
                const data = snap.val();
                stopTurnTimer();
                const nextId = getNextPlayerId(data.players, myId);
                
                if (nextId === data.lastShooter) {
                    roomRef.update({ 
                        tableCard: 0, 
                        turnPlayer: nextId,
                        lastShooter: "" 
                    });
                    alert("å…¨å“¡ãƒ‘ã‚¹ã—ãŸã®ã§å ´ãŒæµã‚Œã¾ã—ãŸï¼");
                } else {
                    roomRef.update({ turnPlayer: nextId });
                }
            });
        }

        function getNextPlayerId(players, currentId) {
            const ids = Object.keys(players);
            const idx = ids.indexOf(currentId);
            return ids[(idx + 1) % ids.length];
        }

        function startTurnTimer() {
            stopTurnTimer();
            document.getElementById('timer-display').innerText = "åˆ¶é™æ™‚é–“: 45ç§’";
            inactivityTimer = setTimeout(() => {
                alert("ã€30ç§’çµŒéã€‘ã‚ã¨15ç§’ã§å¼·åˆ¶é€€å‡ºã§ã™ï¼");
            }, 30000);
           kickTimer = setTimeout(() => {
                alert("æ™‚é–“åˆ‡ã‚Œã®ãŸã‚ã€ãƒ‘ã‚¹ã—ã¦é€€å‡ºã—ã¾ã™");
                
                // 1. æ¬¡ã®äººã«ã‚¿ãƒ¼ãƒ³ã‚’å›ã™ï¼ˆpassTurnã®å‡¦ç†ã‚’ã“ã“ã§ã‚‚å®Ÿè¡Œï¼‰
                roomRef.once('value', (snap) => {
                    const data = snap.val();
                    if (data && data.turnPlayer === myId) {
                        const nextId = getNextPlayerId(data.players, myId);
                        
                        // å…¨å“¡ãƒ‘ã‚¹ã§å ´ãŒæµã‚Œã‚‹åˆ¤å®šã‚‚ä¸€å¿œå…¥ã‚Œã¦ãŠã
                        if (nextId === data.lastShooter) {
                            roomRef.update({ tableCard: 0, turnPlayer: nextId, lastShooter: "" });
                        } else {
                            roomRef.update({ turnPlayer: nextId });
                        }
                    }
                    
                    // 2. è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
                    roomRef.child('players').child(myId).remove();
                    location.reload();
                });
            }, 45000);
        }

        function stopTurnTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(kickTimer);
            document.getElementById('timer-display').innerText = "";
        }

        function showResultScreen(winner) {
            document.getElementById('play-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            document.getElementById('winner-name').innerText = winner;
        }

        function adminReset() {
            if (prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰") === "1204") {
                roomRef.remove().then(() => location.reload());
            }
        }
    </script>
</body>
</html>
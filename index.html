<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŸãƒ‹å¤§å¯Œè±ª - å…¨å“¡æ±ºç€ã‚µãƒã‚¤ãƒãƒ«ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a4a2e; --card-white: #fdfdfd; }
        body { font-family: sans-serif; text-align: center; background: var(--bg-color); color: white; margin: 0; padding: 20px; }
        .card { 
            display: inline-block; width: 65px; height: 95px; background: var(--card-white); color: #333;
            border-radius: 8px; margin: 5px; line-height: 95px; font-size: 24px; font-weight: bold;
            border: 2px solid #000; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer; transition: 0.3s;
        }
        .card:not(.turn-highlight) { opacity: 0.4; cursor: default; transform: scale(0.9); }
        .turn-highlight { border: 4px solid #f1c40f; box-shadow: 0 0 15px #f1c40f; opacity: 1 !important; transform: translateY(-10px) scale(1.1); }
        
        .skill-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 20px 0; }
        .skill-card { width: 120px; padding: 10px; background: #fff; color: #333; border-radius: 10px; border: 3px solid #ccc; cursor: pointer; transition: 0.3s; }
        .skill-card.selected { border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; background: #fffbe6; transform: scale(1.05); }
        .skill-name { font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px; color: #d35400; }
        .skill-desc { font-size: 10px; color: #666; display: block; line-height: 1.2; }

        .screen { display: none; }
        .active { display: block; }
        #table-card { transform: scale(1.2); background: #ffeb3b; margin: 20px auto; opacity: 1 !important; }
        button { padding: 12px 24px; font-size: 16px; border-radius: 5px; border: none; background: #e67e22; color: white; cursor: pointer; margin: 5px; }
        input { padding: 10px; font-size: 16px; border-radius: 5px; border: none; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>ğŸƒ ãƒŸãƒ‹å¤§å¯Œè±ª</h1>
        <input type="text" id="user-name" placeholder="åå‰ã‚’å…¥åŠ›"><br>
        <p style="margin-top:20px;">ã€ãƒ‘ãƒƒã‚·ãƒ–ã‚¹ã‚­ãƒ«ã‚’é¸æŠã€‘</p>
        <div class="skill-container" id="skill-list"></div>
        <button onclick="checkRole()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>

    <div id="wait-screen" class="screen">
        <h2 id="wait-msg">æ¥ç¶šä¸­...</h2>
        <div id="qr-area" style="display:flex; justify-content:center; margin:20px;"></div>
        <p id="player-list">å‚åŠ è€…: å¾…æ©Ÿä¸­...</p>
        <button id="start-btn" style="display:none;" onclick="startGame()">é–‹å§‹</button>
    </div>

    <div id="play-screen" class="screen">
        <div id="timer-display" style="color:#ff6b6b; font-weight:bold; height:30px;"></div>
        <p id="rank-info" style="color: #f1c40f;"></p>
        <p>ã€å ´ã®ã‚«ãƒ¼ãƒ‰ã€‘</p>
        <div id="table-card" class="card">ãƒ¼</div>
        <div id="turn-info" style="margin:10px; font-weight:bold;"></div>
        <hr>
        <div id="my-hand"></div><br>
        <button id="pass-btn" onclick="passTurn()">ãƒ‘ã‚¹ã™ã‚‹</button>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ‰ å…¨å“¡çµ‚äº† ğŸ‰</h1>
        <div id="ranking-list" style="font-size:20px; line-height: 2;"></div>
        <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <button onclick="adminReset()" style="position:fixed; bottom:5px; right:5px; opacity:0.3; font-size:10px; background:#000; color:#fff;">ç®¡ç†è€…ãƒªã‚»ãƒƒãƒˆ</button>

<script>
    // --- Firebaseè¨­å®š (ã‚ãªãŸã®ã‚‚ã®ã«ç½®ãæ›ãˆã¦ãã ã•ã„) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAa1CZBgLYViSMKhg-9D33EZUQwXENFwzo",
        authDomain: "game-496d3.firebaseapp.com",
        projectId: "game-496d3",
        storageBucket: "game-496d3.firebasestorage.app",
        messagingSenderId: "32461027881",
        appId: "1:32461027881:web:06b438a0e2924a2e6b7a38",
        measurementId: "G-HRFJXD28LB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomRef = db.ref('mini_daifugo/game');

    let myId = Math.random().toString(32).substring(2);
    let myName = "";
    let mySkill = "none";
    let isHost = false;
    let kickTimer;
    let lastOutCount = 0; // å¼·æ¬²ãªå£ºç”¨ï¼šã“ã‚Œã¾ã§ã«ä½•äººä¸ŠãŒã£ãŸã‹

    const SKILLS_DATA = [
        { id: "none", name: "èƒ½åŠ›ãªã—", desc: "å®ŸåŠ›ã®ã¿ã§æˆ¦ã†ã‚¹ã‚¿ã‚¤ãƒ«ã€‚" },
        { id: "eightMaster", name: "8åˆ‡ã‚Šè·äºº", desc: "8ã‚’å‡ºã™ã¨å ´ã‚’æµã—ã€è‡ªåˆ†ã®ç•ªã€‚" },
        { id: "curse", name: "å¾©è®ã®å‘ªã„", desc: "ãƒ‘ã‚¹ã™ã‚‹ã¨ä»–å…¨å“¡ã®ã‚«ãƒ¼ãƒ‰ã‚’+1æšã€‚" },
        { id: "greed", name: "å¼·æ¬²ãªå£º", desc: "èª°ã‹ãŒä¸ŠãŒã‚‹ãŸã³ã€æ‰‹æœ­ãŒ1æšæ¸›ã‚‹ã€‚" },
        { id: "antiTwo", name: "ä¸‹å…‹ä¸Šã®è‹±é›„", desc: "ã‚¹ã‚­ãƒ«æ‰€æœ‰è€…ã®ã¿ã€Œ2ã€ã‚’ã€Œ3ã€ã§å€’ã›ã‚‹ã€‚" },
        { id: "lucky", name: "å¹¸é‹ã®å®ˆè­·", desc: "ãƒ‘ã‚¹æ™‚ã€20%ã®ç¢ºç‡ã§æ‰‹æœ­ãŒ1æšæ¸›å°‘ã€‚" }
    ];

    function getRank(num) {
        if (num === 0) return 0;
        if (num === 1) return 14; 
        if (num === 2) return 15;
        return num;
    }

    function toDisp(num) {
        const map = { 1: 'A', 11: 'J', 12: 'Q', 13: 'K', 0: 'ãƒ¼' };
        return map[num] || num;
    }

    function initSkillUI() {
        const container = document.getElementById('skill-list');
        SKILLS_DATA.forEach(skill => {
            const div = document.createElement('div');
            div.className = 'skill-card' + (skill.id === "none" ? ' selected' : '');
            div.id = 'skill-' + skill.id;
            div.innerHTML = `<span class="skill-name">${skill.name}</span><span class="skill-desc">${skill.desc}</span>`;
            div.onclick = () => {
                mySkill = skill.id;
                document.querySelectorAll('.skill-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
            };
            container.appendChild(div);
        });
    }
    initSkillUI();

    async function checkRole() {
        myName = document.getElementById('user-name').value || "ãªãªã—";
        const snap = await roomRef.get();
        const data = snap.val();
        if (!data || data.state === 'finished' || !data.state) {
            isHost = true;
            await roomRef.set({ state: 'waiting', tableCard: 0, winners: [], players: {} });
            new QRCode(document.getElementById("qr-area"), window.location.href);
            document.getElementById('start-btn').style.display = "inline-block";
        }
        joinGame();
    }

    function joinGame() {
        roomRef.child('players').child(myId).set({ name: myName, hand: [0], skill: mySkill, isOut: false });
        roomRef.child('players').child(myId).onDisconnect().remove();
        if (isHost) roomRef.onDisconnect().remove();

        document.getElementById('login-screen').classList.remove('active');
        document.getElementById('wait-screen').classList.add('active');

        roomRef.on('value', (snap) => {
            const data = snap.val();
            if (!data) return;

            const players = data.players || {};
            const winners = data.winners || [];

            // å¼·æ¬²ãªå£ºï¼šèª°ã‹ãŒä¸ŠãŒã£ãŸï¼ˆwinnersãŒå¢—ãˆãŸï¼‰æ™‚ã«ç™ºå‹•
            if (mySkill === 'greed' && winners.length > lastOutCount && !players[myId].isOut) {
                const myHand = [...(players[myId].hand || [])];
                if (myHand.length > 0) {
                    myHand.splice(0, 1);
                    roomRef.child('players').child(myId).update({ hand: myHand });
                    alert("å¼·æ¬²ãªå£ºç™ºå‹•ï¼èª°ã‹ãŒä¸ŠãŒã£ãŸã®ã§æ‰‹æœ­ã‚’1æšæ¨ã¦ã¾ã—ãŸã€‚");
                    if (myHand.length === 0) handleWin(data);
                }
                lastOutCount = winners.length;
            } else {
                lastOutCount = winners.length;
            }

            const pKeys = Object.keys(players);
            document.getElementById('player-list').innerText = "å‚åŠ è€…: " + pKeys.map(k => players[k].name).join(", ");
            
            if (data.state === 'playing') {
                if (players[myId].isOut) {
                    document.getElementById('play-screen').classList.add('active');
                    document.getElementById('turn-info').innerText = "ã‚ãªãŸã¯ã‚ãŒã‚Šã¾ã—ãŸã€‚è¦³æˆ¦ä¸­...";
                    document.getElementById('my-hand').innerHTML = "";
                    document.getElementById('pass-btn').disabled = true;
                } else {
                    showPlayScreen(data);
                }
            }
            if (data.state === 'finished') showResultScreen(winners, players);
        });
    }

    function startGame() {
        roomRef.child('players').once('value', (snap) => {
            const players = snap.val();
            const ids = Object.keys(players);
            let deck = [];
            for (let i = 1; i <= 13; i++) for (let j = 0; j < 4; j++) deck.push(i);
            deck.sort(() => Math.random() - 0.5);
            ids.forEach(id => {
                let hand = deck.splice(0, 6).sort((a, b) => a - b);
                roomRef.child('players').child(id).update({ hand: hand, isOut: false });
            });
            roomRef.update({ state: 'playing', tableCard: 0, turnPlayer: ids[0], lastShooter: "", winners: [] });
        });
    }

    function showPlayScreen(data) {
        document.getElementById('wait-screen').classList.remove('active');
        document.getElementById('play-screen').classList.add('active');
        document.getElementById('table-card').innerText = toDisp(data.tableCard);
        
        const isMyTurn = (data.turnPlayer === myId);
        document.getElementById('turn-info').innerText = isMyTurn ? "â˜… ã‚ãªãŸã®ç•ªã§ã™ â˜…" : `${data.players[data.turnPlayer]?.name}ã•ã‚“ã®ç•ª`;
        document.getElementById('pass-btn').disabled = !isMyTurn;

        if (isMyTurn) startTimer(); else stopTimer();

        const myHand = data.players[myId].hand || [];
        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = "";
        const top = data.tableCard || 0;

        myHand.forEach((num, idx) => {
            const c = document.createElement('div');
            const can = isMyTurn && (
                top === 0 || 
                (top === 2 && num === 3 && mySkill === 'antiTwo') || 
                (num === 2 && top !== 2) || 
                (num !== 2 && getRank(num) > getRank(top))
            );
            c.className = 'card' + (can ? ' turn-highlight' : '');
            c.innerText = toDisp(num);
            c.onclick = () => can && playCard(num, idx, myHand);
            handDiv.appendChild(c);
        });
    }

    function playCard(num, idx, hand) {
        roomRef.once('value', (snap) => {
            const data = snap.val();
            hand.splice(idx, 1);
            
            let nextCard = num;
            let nextShooter = myId;
            let nextId;

            if (mySkill === "eightMaster" && num === 8) {
                alert("8åˆ‡ã‚Šï¼");
                nextId = myId; nextCard = 0; nextShooter = "";
            } else {
                nextId = getNextPlayerId(data.players, myId);
            }

            if (hand.length === 0) {
                handleWin(data, nextId, nextCard, nextShooter);
            } else {
                roomRef.child('players').child(myId).update({ hand: hand });
                roomRef.update({ tableCard: nextCard, turnPlayer: nextId, lastShooter: nextShooter });
            }
        });
    }

    function handleWin(data, nextId, nextCard, nextShooter) {
        const winners = data.winners || [];
        winners.push(myName);
        
        // ã¾ã æ®‹ã£ã¦ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ•°ã‚’ç¢ºèª
        const activePlayers = Object.keys(data.players).filter(id => id !== myId && !data.players[id].isOut);
        
        if (activePlayers.length === 0) {
            // å…¨å“¡çµ‚äº†
            roomRef.child('players').child(myId).update({ hand: [], isOut: true });
            roomRef.update({ winners: winners, state: 'finished' });
        } else {
            // ã¾ã ç¶šãã€‚è‡ªåˆ†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ¬¡ã®äººã‚’è¨ˆç®—
            if (!nextId) nextId = getNextPlayerId(data.players, myId); 
            roomRef.child('players').child(myId).update({ hand: [], isOut: true });
            roomRef.update({ winners: winners, turnPlayer: nextId, tableCard: nextCard || 0, lastShooter: nextShooter || "" });
            alert("ã‚ãŒã‚Šï¼ä»–ã®äººã®å¯¾æˆ¦ã‚’å¾…ã£ã¦ã„ã¾ã™...");
        }
    }

    function passTurn() {
        roomRef.once('value', (snap) => {
            const data = snap.val();
            const myHand = [...(data.players[myId].hand || [])];

            if (mySkill === "curse") {
                Object.keys(data.players).forEach(pId => {
                    if (pId !== myId && !data.players[pId].isOut) {
                        const h = [...(data.players[pId].hand || []), Math.floor(Math.random() * 13) + 1].sort((a,b)=>a-b);
                        roomRef.child('players').child(pId).update({ hand: h });
                    }
                });
            }

            if (mySkill === "lucky" && Math.random() < 0.2 && myHand.length > 0) {
                myHand.splice(0, 1);
                roomRef.child('players').child(myId).update({ hand: myHand });
                if (myHand.length === 0) { handleWin(data); return; }
            }

            const nextId = getNextPlayerId(data.players, myId);
            if (nextId === data.lastShooter) roomRef.update({ tableCard: 0, turnPlayer: nextId, lastShooter: "" });
            else roomRef.update({ turnPlayer: nextId });
        });
    }

    function getNextPlayerId(players, cId) {
        const ids = Object.keys(players);
        let idx = ids.indexOf(cId);
        for (let i = 1; i < ids.length; i++) {
            let nextIdx = (idx + i) % ids.length;
            let nextId = ids[nextIdx];
            if (!players[nextId].isOut) return nextId;
        }
        return cId; 
    }

    function startTimer() {
        stopTimer();
        document.getElementById('timer-display').innerText = "åˆ¶é™æ™‚é–“: 45ç§’";
        kickTimer = setTimeout(() => { passTurn(); roomRef.child('players').child(myId).remove(); location.reload(); }, 45000);
    }
    function stopTimer() { clearTimeout(kickTimer); document.getElementById('timer-display').innerText = ""; }

    function showResultScreen(winners, players) {
        document.getElementById('play-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        const list = document.getElementById('ranking-list');
        list.innerHTML = winners.map((name, i) => `<div>${i+1}ä½: ${name}</div>`).join("");
        
        // ãƒ‰ãƒ™ï¼ˆæœ€å¾Œã®ä¸€äººï¼‰ã‚’è¿½åŠ 
        const allIds = Object.keys(players);
        const outIds = allIds.filter(id => players[id].isOut);
        const lastId = allIds.find(id => !players[id].isOut);
        if (lastId) {
            list.innerHTML += `<div style="color: #666;">ãƒ‰ãƒ™: ${players[lastId].name}</div>`;
        }
    }

    function adminReset() { if (prompt("PASS") === "1204") roomRef.remove().then(() => location.reload()); }
</script>
</body>
</html>
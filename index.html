<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŸãƒ‹å¤§å¯Œè±ª - ã‚¹ã‚­ãƒ«ãƒ»æ±ºæˆ¦</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a4a2e; --card-white: #fdfdfd; --accent: #f1c40f; }
        body { font-family: sans-serif; text-align: center; background: var(--bg-color); color: white; margin: 0; padding: 20px; overflow-x: hidden; }
        
        #skill-cutin {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: rgba(241, 196, 15, 0.9); color: #000; padding: 20px 40px;
            font-size: 32px; font-weight: bold; border-radius: 50px; z-index: 2000;
            pointer-events: none; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 30px rgba(0,0,0,0.5); white-space: nowrap;
        }
        #skill-cutin.show { transform: translate(-50%, -50%) scale(1.2); }

        #my-skill-status {
            position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); 
            padding: 8px 15px; border-radius: 20px; font-size: 12px; border: 1px solid var(--accent); z-index: 1000;
            display: none; text-align: left;
        }

        .card { 
            display: inline-block; width: 65px; height: 95px; background: var(--card-white); color: #333;
            border-radius: 8px; margin: 5px; line-height: 95px; font-size: 24px; font-weight: bold;
            border: 2px solid #000; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer; transition: 0.3s;
        }
        .card:not(.turn-highlight) { opacity: 0.4; cursor: default; transform: scale(0.9); }
        .turn-highlight { border: 4px solid var(--accent); box-shadow: 0 0 15px var(--accent); opacity: 1 !important; transform: translateY(-10px) scale(1.1); }
        
        .skill-card { width: 120px; padding: 10px; background: #fff; color: #333; border-radius: 10px; border: 3px solid #ccc; cursor: pointer; margin: 5px; display: inline-block; }
        .skill-card.selected { border-color: var(--accent); background: #fffbe6; transform: scale(1.05); }

        .screen { display: none; }
        .active { display: block; }
        #table-card { transform: scale(1.2); background: #ffeb3b; margin: 20px auto; opacity: 1 !important; }
        button { padding: 12px 24px; font-size: 16px; border-radius: 5px; border: none; background: #e67e22; color: white; cursor: pointer; margin: 5px; }
        button:disabled { background: #777; cursor: not-allowed; opacity: 0.5; }
        input { padding: 10px; font-size: 16px; border-radius: 5px; border: none; }
    </style>
</head>
<body>

    <div id="skill-cutin">ã‚¹ã‚­ãƒ«ç™ºå‹•ï¼</div>

    <div id="my-skill-status">
        ğŸ›¡ï¸ <span id="status-skill-name" style="color: var(--accent); font-weight: bold;">---</span><br>
        <span id="status-skill-desc" style="font-size: 9px; color: #ccc;"></span>
    </div>

    <div id="login-screen" class="screen active">
        <h1>ğŸƒ ãƒŸãƒ‹å¤§å¯Œè±ª</h1>
        <input type="text" id="user-name" placeholder="åå‰ã‚’å…¥åŠ›"><br>
        <p>ã€ãƒ‘ãƒƒã‚·ãƒ–ã‚¹ã‚­ãƒ«ã‚’é¸æŠã€‘</p>
        <div id="skill-list" style="margin: 15px 0;"></div>
        <button onclick="checkRole()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>

    <div id="wait-screen" class="screen">
        <h2>å‚åŠ è€…å¾…æ©Ÿä¸­...</h2>
        <div id="qr-area" style="display:flex; justify-content:center; margin:20px;"></div>
        <p id="player-list"></p>
        <button id="start-btn" style="display:none;" onclick="startGame()">é–‹å§‹</button>
    </div>

    <div id="play-screen" class="screen">
        <div id="timer-display" style="color:#ff6b6b; font-weight:bold; height:30px; margin-top: 40px;"></div>
        <div id="table-card" class="card">ãƒ¼</div>
        <div id="turn-info" style="margin:10px; font-weight:bold;"></div>
        <div id="pass-hint" style="font-size: 11px; color: #ffeb3b; height: 15px;"></div>
        <hr>
        <div id="my-hand"></div><br>
        <button id="pass-btn" onclick="passTurn()">ãƒ‘ã‚¹ã™ã‚‹</button>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ‰ å…¨å“¡çµ‚äº† ğŸ‰</h1>
        <div id="ranking-list" style="font-size:22px; line-height: 2;"></div>
        <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <button onclick="adminReset()" style="position:fixed; bottom:5px; right:5px; opacity:0.2; font-size:10px; background:#000; color:#fff;">ãƒªã‚»ãƒƒãƒˆ</button>

<script>
    // --- Firebaseè¨­å®š ---
    const firebaseConfig = {
        apiKey: "AIzaSyAa1CZBgLYViSMKhg-9D33EZUQwXENFwzo",
        authDomain: "game-496d3.firebaseapp.com",
        projectId: "game-496d3",
        storageBucket: "game-496d3.firebasestorage.app",
        messagingSenderId: "32461027881",
        appId: "1:32461027881:web:06b438a0e2924a2e6b7a38",
        measurementId: "G-HRFJXD28LB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomRef = db.ref('mini_daifugo/game');

    let myId = Math.random().toString(32).substring(2);
    let myName = "";
    let mySkill = "none";
    let isHost = false;
    let kickTimer;
    let lastOutCount = 0;

    const SKILLS_DATA = [
        { id: "none", name: "ä¿ºã¯å¼·ã„ãœ", desc: "å®ŸåŠ›ã®ã¿ã§æˆ¦ã†ã€‚" },
        { id: "eightMaster", name: "8åˆ‡ã‚Šè·äºº", desc: "8ã§å ´ã‚’æµã™ã€‚" },
        { id: "curse", name: "å¾©è®ã®å‘ªã„", desc: "ãƒ‘ã‚¹ã§ä»–å…¨å“¡+1æšã€‚" },
        { id: "greed", name: "å¼·æ¬²ãªå£º", desc: "èª°ã‹ãŒã‚ãŒã‚‹ã¨æ‰‹æœ­-1æšã€‚" },
        { id: "antiTwo", name: "ä¸‹å…‹ä¸Šã®è‹±é›„", desc: "3ã§2ã‚’å€’ã›ã‚‹ã€‚" },
        { id: "lucky", name: "å¹¸é‹ã®å®ˆè­·", desc: "ãƒ‘ã‚¹æ™‚20%ã§æ‰‹æœ­-1æšã€‚" }
    ];

    function initSkillUI() {
        const container = document.getElementById('skill-list');
        SKILLS_DATA.forEach(skill => {
            const div = document.createElement('div');
            div.className = 'skill-card' + (skill.id === "none" ? ' selected' : '');
            div.innerHTML = `<span style="font-weight:bold; font-size:14px;">${skill.name}</span><br><span style="font-size:10px; color:#666;">${skill.desc}</span>`;
            div.onclick = () => {
                mySkill = skill.id;
                document.querySelectorAll('.skill-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
            };
            container.appendChild(div);
        });
    }
    initSkillUI();

    function showSkillEffect(text) {
        const el = document.getElementById('skill-cutin');
        el.innerText = text;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 1500);
    }

    async function checkRole() {
        myName = document.getElementById('user-name').value || "ãªãªã—";
        const snap = await roomRef.get();
        const data = snap.val();
        if (!data || data.state === 'finished' || !data.state) {
            isHost = true;
            await roomRef.set({ state: 'waiting', tableCard: 0, winners: [], players: {}, lastSkill: "" });
            new QRCode(document.getElementById("qr-area"), window.location.href);
            document.getElementById('start-btn').style.display = "inline-block";
        }
        joinGame();
    }

    function joinGame() {
        roomRef.child('players').child(myId).set({ name: myName, hand: [0], skill: mySkill, isOut: false });
        roomRef.child('players').child(myId).onDisconnect().remove();
        if (isHost) roomRef.onDisconnect().remove();

        document.getElementById('login-screen').classList.remove('active');
        document.getElementById('wait-screen').classList.add('active');

        roomRef.on('value', (snap) => {
            const data = snap.val();
            if (!data || !data.players) return;

            const players = data.players;
            const winners = data.winners || [];

            if (data.lastEffectId !== this.prevEffectId && data.lastSkill) {
                showSkillEffect(data.lastSkill);
                this.prevEffectId = data.lastEffectId;
            }

            if (mySkill === 'greed' && winners.length > lastOutCount && players[myId] && !players[myId].isOut) {
                const myHand = [...(players[myId].hand || [])];
                if (myHand.length > 0) {
                    myHand.splice(0, 1);
                    roomRef.child('players').child(myId).update({ hand: myHand });
                    roomRef.update({ lastSkill: `å¼·æ¬²ãªå£ºï¼æ‰‹æœ­æ¸›å°‘ (${myName})`, lastEffectId: Math.random() });
                    if (myHand.length === 0) handleWin(data);
                }
            }
            lastOutCount = winners.length;

            document.getElementById('player-list').innerText = "å‚åŠ è€…: " + Object.keys(players).map(k => k === myId ? players[k].name + " (ã‚ãªãŸ)" : players[k].name).join(", ");
            
            if (data.state === 'playing') {
                document.getElementById('my-skill-status').style.display = "block";
                const s = SKILLS_DATA.find(sd => sd.id === mySkill);
                document.getElementById('status-skill-name').innerText = s.name;
                document.getElementById('status-skill-desc').innerText = s.desc;

                if (players[myId] && players[myId].isOut) {
                    document.getElementById('wait-screen').classList.remove('active');
                    document.getElementById('play-screen').classList.add('active');
                    document.getElementById('turn-info').innerText = "ã‚ãªãŸã¯ã‚ãŒã‚Šã¾ã—ãŸã€‚è¦³æˆ¦ä¸­...";
                    document.getElementById('my-hand').innerHTML = "";
                    document.getElementById('pass-btn').disabled = true;
                    document.getElementById('pass-hint').innerText = "";
                } else {
                    showPlayScreen(data);
                }
            }
            if (data.state === 'finished') {
                document.getElementById('my-skill-status').style.display = "none";
                showResultScreen(winners, players);
            }
        });
    }

    function startGame() {
        roomRef.child('players').once('value', (snap) => {
            const players = snap.val();
            const ids = Object.keys(players);
            if (ids.length < 2) { alert("2äººä»¥ä¸Šå¿…è¦ã§ã™"); return; }
            let deck = [];
            for (let i = 1; i <= 13; i++) for (let j = 0; j < 4; j++) deck.push(i);
            deck.sort(() => Math.random() - 0.5);
            ids.forEach(id => {
                let hand = deck.splice(0, 6).sort((a, b) => a - b);
                roomRef.child('players').child(id).update({ hand: hand, isOut: false });
            });
            roomRef.update({ state: 'playing', tableCard: 0, turnPlayer: ids[0], lastShooter: "", winners: [], lastSkill: "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼", lastEffectId: Math.random() });
        });
    }

    // å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
    function canPlayAny(hand, top) {
        return hand.some(num => {
            if (top === 0) return true;
            if (top === 2 && num === 3 && mySkill === 'antiTwo') return true;
            if (num === 2 && top !== 2) return true;
            if (num !== 2 && getRank(num) > getRank(top)) return true;
            return false;
        });
    }

    function showPlayScreen(data) {
        document.getElementById('wait-screen').classList.remove('active');
        document.getElementById('play-screen').classList.add('active');
        document.getElementById('table-card').innerText = toDisp(data.tableCard);
        const isMyTurn = (data.turnPlayer === myId);
        document.getElementById('turn-info').innerText = isMyTurn ? "â˜… ã‚ãªãŸã®ç•ª â˜…" : `${data.players[data.turnPlayer]?.name}ã•ã‚“ã®ç•ª`;
        
        const myHand = data.players[myId].hand || [];
        const top = data.tableCard || 0;

        // â˜… æˆ¦ç•¥çš„ãƒ‘ã‚¹ç¦æ­¢ãƒ­ã‚¸ãƒƒã‚¯
        const canIPlay = canPlayAny(myHand, top);
        const passBtn = document.getElementById('pass-btn');
        const passHint = document.getElementById('pass-hint');

        if (isMyTurn) {
            startTimer();
            if (canIPlay) {
                passBtn.disabled = true;
                passHint.innerText = "å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹ãŸã‚ãƒ‘ã‚¹ã§ãã¾ã›ã‚“";
            } else {
                passBtn.disabled = false;
                passHint.innerText = "å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ãŒãªã„ã®ã§ãƒ‘ã‚¹ã§ãã¾ã™";
            }
        } else {
            stopTimer();
            passBtn.disabled = true;
            passHint.innerText = "";
        }

        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = "";
        myHand.forEach((num, idx) => {
            const c = document.createElement('div');
            const isAnti = (top === 2 && num === 3 && mySkill === 'antiTwo');
            const can = isMyTurn && (top === 0 || isAnti || (num === 2 && top !== 2) || (num !== 2 && getRank(num) > getRank(top)));
            c.className = 'card' + (can ? ' turn-highlight' : '');
            c.innerText = toDisp(num);
            c.onclick = () => {
                if(can) {
                    if(isAnti) roomRef.update({ lastSkill: `ä¸‹å…‹ä¸Šï¼ (${myName})`, lastEffectId: Math.random() });
                    playCard(num, idx, myHand);
                }
            };
            handDiv.appendChild(c);
        });
    }

    function playCard(num, idx, hand) {
        roomRef.once('value', (snap) => {
            const data = snap.val();
            hand.splice(idx, 1);
            let nextCard = num; let nextShooter = myId; let nextId;
            if (mySkill === "eightMaster" && num === 8) {
                roomRef.update({ lastSkill: `8åˆ‡ã‚Šï¼ (${myName})`, lastEffectId: Math.random() });
                nextId = myId; nextCard = 0; nextShooter = "";
            } else {
                nextId = getNextPlayerId(data.players, myId);
            }
            if (hand.length === 0) handleWin(data, nextId, nextCard, nextShooter);
            else {
                roomRef.child('players').child(myId).update({ hand: hand });
                roomRef.update({ tableCard: nextCard, turnPlayer: nextId, lastShooter: nextShooter });
            }
        });
    }

    function handleWin(data, nextId, nextCard, nextShooter) {
        const winners = data.winners || [];
        winners.push(myName);
        const activePlayers = Object.keys(data.players).filter(id => id !== myId && !data.players[id].isOut);
        if (activePlayers.length <= 1) {
            if (activePlayers.length === 1) winners.push(data.players[activePlayers[0]].name);
            roomRef.child('players').child(myId).update({ hand: [], isOut: true });
            roomRef.update({ winners: winners, state: 'finished' });
        } else {
            if (!nextId) nextId = getNextPlayerId(data.players, myId); 
            roomRef.child('players').child(myId).update({ hand: [], isOut: true });
            roomRef.update({ winners: winners, turnPlayer: nextId, tableCard: nextCard || 0, lastShooter: nextShooter || "" });
        }
    }

    function passTurn() {
        roomRef.once('value', (snap) => {
            const data = snap.val();
            const myHand = [...(data.players[myId].hand || [])];
            if (mySkill === "curse") {
                roomRef.update({ lastSkill: `å‘ªã„ï¼å…¨å“¡ãƒ‰ãƒ­ãƒ¼ (${myName})`, lastEffectId: Math.random() });
                Object.keys(data.players).forEach(pId => {
                    if (pId !== myId && !data.players[pId].isOut) {
                        const h = [...(data.players[pId].hand || []), Math.floor(Math.random() * 13) + 1].sort((a,b)=>a-b);
                        roomRef.child('players').child(pId).update({ hand: h });
                    }
                });
            }
            if (mySkill === "lucky" && Math.random() < 0.2 && myHand.length > 0) {
                myHand.splice(0, 1);
                roomRef.child('players').child(myId).update({ hand: myHand });
                roomRef.update({ lastSkill: `å¹¸é‹ï¼æ‰‹æœ­æ¸›å°‘ (${myName})`, lastEffectId: Math.random() });
                if (myHand.length === 0) { handleWin(data); return; }
            }
            const nextId = getNextPlayerId(data.players, myId);
            if (nextId === data.lastShooter) roomRef.update({ tableCard: 0, turnPlayer: nextId, lastShooter: "" });
            else roomRef.update({ turnPlayer: nextId });
        });
    }

    function getNextPlayerId(players, cId) {
        const ids = Object.keys(players);
        let idx = ids.indexOf(cId);
        for (let i = 1; i < ids.length; i++) {
            let nextId = ids[(idx + i) % ids.length];
            if (players[nextId] && !players[nextId].isOut) return nextId;
        }
        return cId; 
    }

    function startTimer() { stopTimer(); kickTimer = setTimeout(() => { passTurn(); roomRef.child('players').child(myId).remove(); location.reload(); }, 45000); }
    function stopTimer() { clearTimeout(kickTimer); }

    function showResultScreen(winners, players) {
        document.getElementById('play-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        document.getElementById('ranking-list').innerHTML = winners.map((name, i) => `<div>${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'ğŸ–ï¸'} ${i+1}ä½: ${name}</div>`).join("");
    }

    function toDisp(num) { const map = { 1: 'A', 11: 'J', 12: 'Q', 13: 'K', 0: 'ãƒ¼' }; return map[num] || num; }
    function getRank(num) { return num === 1 ? 14 : num === 2 ? 15 : num; }
    function adminReset() { if (prompt("PASS") === "1204") roomRef.remove().then(() => location.reload()); }
</script>
</body>
</html>
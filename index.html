<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŸãƒ‹å¤§å¯Œè±ª - ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰å¯¾æˆ¦ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a4a2e; --card-white: #fdfdfd; }
        body { font-family: sans-serif; text-align: center; background: var(--bg-color); color: white; margin: 0; padding: 20px; }
        
        /* ã‚«ãƒ¼ãƒ‰åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .card { 
            display: inline-block; width: 65px; height: 95px; background: var(--card-white); color: #333;
            border-radius: 8px; margin: 5px; line-height: 95px; font-size: 24px; font-weight: bold;
            border: 2px solid #000; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer; transition: 0.3s;
        }
        
        /* ãƒ—ãƒ¬ã‚¤ç”»é¢ã®ã‚¬ã‚¤ãƒ‰æ¼”å‡º */
        .card:not(.turn-highlight) { opacity: 0.4; cursor: default; transform: scale(0.9); }
        .turn-highlight { border: 4px solid #f1c40f; box-shadow: 0 0 15px #f1c40f; opacity: 1 !important; transform: translateY(-10px) scale(1.1); }
        
        /* ã‚¹ã‚­ãƒ«é¸æŠã‚«ãƒ¼ãƒ‰ */
        .skill-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin: 20px 0; }
        .skill-card { 
            width: 130px; padding: 12px; background: #fff; color: #333; border-radius: 10px; 
            border: 3px solid #ccc; cursor: pointer; transition: 0.3s; 
        }
        .skill-card.selected { border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; background: #fffbe6; transform: scale(1.05); }
        .skill-name { font-weight: bold; font-size: 15px; display: block; margin-bottom: 5px; color: #d35400; }
        .skill-desc { font-size: 11px; color: #666; display: block; line-height: 1.3; }

        .screen { display: none; }
        .active { display: block; }
        #table-card { transform: scale(1.2); background: #ffeb3b; margin: 20px auto; opacity: 1 !important; }
        button { padding: 12px 24px; font-size: 16px; border-radius: 5px; border: none; background: #e67e22; color: white; cursor: pointer; margin: 5px; }
        input { padding: 10px; font-size: 16px; border-radius: 5px; border: none; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>ğŸƒ ãƒŸãƒ‹å¤§å¯Œè±ª</h1>
        <input type="text" id="user-name" placeholder="åå‰ã‚’å…¥åŠ›"><br>
        <p style="margin-top:20px;">ã€ãƒ‘ãƒƒã‚·ãƒ–ã‚¹ã‚­ãƒ«ã‚’é¸æŠã€‘</p>
        <div class="skill-container" id="skill-list"></div>
        <button onclick="checkRole()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>

    <div id="wait-screen" class="screen">
        <h2 id="wait-msg">æ¥ç¶šä¸­...</h2>
        <div id="qr-area" style="display:flex; justify-content:center; margin:20px;"></div>
        <p id="player-list">å‚åŠ è€…: å¾…æ©Ÿä¸­...</p>
        <button id="start-btn" style="display:none;" onclick="startGame()">å…¨å“¡æƒã£ãŸï¼é–‹å§‹</button>
    </div>

    <div id="play-screen" class="screen">
        <div id="timer-display" style="color:#ff6b6b; font-weight:bold; height:30px;"></div>
        <p>ã€å ´ã®ã‚«ãƒ¼ãƒ‰ã€‘</p>
        <div id="table-card" class="card">ãƒ¼</div>
        <div id="turn-info" style="margin:10px; font-weight:bold;"></div>
        <hr>
        <div id="my-hand"></div><br>
        <button id="pass-btn" onclick="passTurn()">ãƒ‘ã‚¹ã™ã‚‹</button>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ‰ å„ªå‹ ğŸ‰</h1>
        <div id="winner-name" style="font-size:40px; color:gold;"></div>
        <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <button onclick="adminReset()" style="position:fixed; bottom:5px; right:5px; opacity:0.3; font-size:10px; background:#000; color:#fff;">ç®¡ç†è€…ãƒªã‚»ãƒƒãƒˆ</button>

<script>
    // --- åˆæœŸè¨­å®š ---
    const firebaseConfig = {
        apiKey: "AIzaSyAa1CZBgLYViSMKhg-9D33EZUQwXENFwzo",
        authDomain: "game-496d3.firebaseapp.com",
        projectId: "game-496d3",
        storageBucket: "game-496d3.firebasestorage.app",
        messagingSenderId: "32461027881",
        appId: "1:32461027881:web:06b438a0e2924a2e6b7a38",
        measurementId: "G-HRFJXD28LB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomRef = db.ref('mini_daifugo/game');

    let myId = Math.random().toString(32).substring(2);
    let myName = "";
    let mySkill = "none";
    let isHost = false;
    let kickTimer;

    const SKILLS_DATA = [
        { id: "none", name: "èƒ½åŠ›ãªã—", desc: "å®ŸåŠ›ã®ã¿ã§æˆ¦ã†ã€ç¡¬æ´¾ãªã‚¹ã‚¿ã‚¤ãƒ«ã€‚" },
        { id: "curse", name: "å¾©è®ã®å‘ªã„", desc: "è‡ªåˆ†ãŒãƒ‘ã‚¹ã™ã‚‹ã¨ã€ä»–ã®å…¨å“¡ã«ã‚«ãƒ¼ãƒ‰ã‚’+1æšã™ã‚‹ã€‚" },
        { id: "eightMaster", name: "8åˆ‡ã‚Šè·äºº", desc: "8ã‚’å‡ºã™ã¨å ´ã‚’æµã—ã€ã‚‚ã†ä¸€åº¦è‡ªåˆ†ã®ç•ªã«ãªã‚‹ã€‚" }
    ];

    // --- è£œåŠ©é–¢æ•° ---
    function getRank(num) {
        if (num === 0) return 0;
        if (num === 1) return 14; 
        if (num === 2) return 15;
        return num;
    }

    function toDisp(num) {
        const map = { 1: 'A', 11: 'J', 12: 'Q', 13: 'K', 0: 'ãƒ¼' };
        return map[num] || num;
    }

    // --- ã‚¹ã‚­ãƒ«é¸æŠUIã®ç”Ÿæˆ ---
    function initSkillUI() {
        const container = document.getElementById('skill-list');
        SKILLS_DATA.forEach(skill => {
            const div = document.createElement('div');
            div.className = 'skill-card' + (skill.id === "none" ? ' selected' : '');
            div.id = 'skill-' + skill.id;
            div.innerHTML = `<span class="skill-name">${skill.name}</span><span class="skill-desc">${skill.desc}</span>`;
            div.onclick = () => {
                mySkill = skill.id;
                document.querySelectorAll('.skill-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
            };
            container.appendChild(div);
        });
    }
    initSkillUI();

    // --- å‚åŠ ãƒ»å¾…æ©Ÿå‡¦ç† ---
    async function checkRole() {
        myName = document.getElementById('user-name').value || "ãªãªã—";
        const snap = await roomRef.get();
        const data = snap.val();

        if (!data || data.state === 'finished' || !data.state) {
            isHost = true;
            await roomRef.set({ state: 'waiting', tableCard: 0, lastUpdate: Date.now(), players: {} });
            new QRCode(document.getElementById("qr-area"), window.location.href);
            document.getElementById('start-btn').style.display = "inline-block";
        }
        joinGame();
    }

    function joinGame() {
        roomRef.child('players').child(myId).set({ name: myName, hand: [0], skill: mySkill });
        roomRef.child('players').child(myId).onDisconnect().remove();
        if (isHost) roomRef.onDisconnect().remove();

        document.getElementById('login-screen').classList.remove('active');
        document.getElementById('wait-screen').classList.add('active');

        roomRef.on('value', (snap) => {
            const data = snap.val();
            if (!data) return;
            const pKeys = Object.keys(data.players || {});
            document.getElementById('player-list').innerText = "å‚åŠ è€…: " + pKeys.map(k => data.players[k].name).join(", ");
            if (data.state === 'playing') showPlayScreen(data);
            if (data.state === 'finished') showResultScreen(data.winners);
        });
    }

    function startGame() {
        roomRef.child('players').once('value', (snap) => {
            const players = snap.val();
            const ids = Object.keys(players);
            let deck = [];
            for (let i = 1; i <= 13; i++) for (let j = 0; j < 4; j++) deck.push(i);
            deck.sort(() => Math.random() - 0.5);

            ids.forEach(id => {
                let hand = deck.splice(0, 6).sort((a, b) => a - b);
                roomRef.child('players').child(id).update({ hand: hand });
            });
            roomRef.update({ state: 'playing', tableCard: 0, turnPlayer: ids[0], lastShooter: "" });
        });
    }

    // --- ã‚²ãƒ¼ãƒ ç”»é¢æ›´æ–° ---
    function showPlayScreen(data) {
        document.getElementById('wait-screen').classList.remove('active');
        document.getElementById('play-screen').classList.add('active');
        document.getElementById('table-card').innerText = toDisp(data.tableCard);
        
        const isMyTurn = (data.turnPlayer === myId);
        document.getElementById('turn-info').innerText = isMyTurn ? "â˜… ã‚ãªãŸã®ç•ªã§ã™ â˜…" : `${data.players[data.turnPlayer]?.name}ã•ã‚“ã®ç•ªã§ã™`;
        document.getElementById('pass-btn').disabled = !isMyTurn;

        if (isMyTurn) startTimer(); else stopTimer();

        const myData = data.players[myId];
        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = "";
        if (myData && myData.hand) {
            const top = data.tableCard || 0;
            myData.hand.forEach((num, idx) => {
                const c = document.createElement('div');
                // å‡ºã›ã‚‹æ¡ä»¶åˆ¤å®š
                const myRank = getRank(num);
                const topRank = getRank(top);
                const can = isMyTurn && (top === 0 || (top === 2 && num === 3) || (num === 2 && top !== 2) || (num !== 2 && myRank > topRank));
                
                c.className = 'card' + (can ? ' turn-highlight' : '');
                c.innerText = toDisp(num);
                c.onclick = () => can && playCard(num, idx, myData.hand);
                handDiv.appendChild(c);
            });
        }
    }

    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    function playCard(num, idx, hand) {
        roomRef.once('value', (snap) => {
            const data = snap.val();
            hand.splice(idx, 1);
            let nextId = getNextPlayerId(data.players, myId);
            let nextCard = num;
            let nextShooter = myId;

            if (mySkill === "eightMaster" && num === 8) {
                alert("8åˆ‡ã‚Šç™ºå‹•ï¼è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ãŒç¶šãã¾ã™ã€‚");
                nextId = myId; nextCard = 0; nextShooter = "";
            }

            roomRef.update({ tableCard: nextCard, turnPlayer: nextId, lastShooter: nextShooter });
            roomRef.child('players').child(myId).update({ hand: hand });
            if (hand.length === 0) roomRef.update({ state: 'finished', winners: myName });
        });
    }

    function passTurn() {
        roomRef.once('value', (snap) => {
            const data = snap.val();
            if (mySkill === "curse") {
                Object.keys(data.players).forEach(pId => {
                    if (pId !== myId) {
                        const newCard = Math.floor(Math.random() * 13) + 1;
                        const newHand = [...(data.players[pId].hand || []), newCard].sort((a,b)=>a-b);
                        roomRef.child('players').child(pId).update({ hand: newHand });
                    }
                });
                alert("å‘ªã„ç™ºå‹•ï¼ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ãŒå¢—ãˆã¾ã—ãŸã€‚");
            }
            const nextId = getNextPlayerId(data.players, myId);
            if (nextId === data.lastShooter) roomRef.update({ tableCard: 0, turnPlayer: nextId, lastShooter: "" });
            else roomRef.update({ turnPlayer: nextId });
        });
    }

    function getNextPlayerId(players, cId) {
        const ids = Object.keys(players);
        return ids[(ids.indexOf(cId) + 1) % ids.length];
    }

    // --- ã‚¿ã‚¤ãƒãƒ¼ãƒ»ãƒªã‚»ãƒƒãƒˆ ---
    function startTimer() {
        stopTimer();
        document.getElementById('timer-display').innerText = "åˆ¶é™æ™‚é–“: 45ç§’";
        kickTimer = setTimeout(() => { passTurn(); roomRef.child('players').child(myId).remove(); location.reload(); }, 45000);
    }
    function stopTimer() { clearTimeout(kickTimer); document.getElementById('timer-display').innerText = ""; }
    function showResultScreen(w) { document.getElementById('play-screen').classList.remove('active'); document.getElementById('result-screen').classList.add('active'); document.getElementById('winner-name').innerText = w; }
    function adminReset() { if (prompt("PASS") === "1204") roomRef.remove().then(() => location.reload()); }
</script>
</body>
</html>
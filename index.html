<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŸãƒ‹å¤§å¯Œè±ª - ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a4a2e; --card-white: #fdfdfd; --accent: #f1c40f; }
        body { font-family: sans-serif; text-align: center; background: var(--bg-color); color: white; margin: 0; padding: 10px; overflow-x: hidden; }
        
        #skill-cutin {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: rgba(241, 196, 15, 0.95); color: #000; padding: 15px 20px;
            font-size: 20px; font-weight: bold; border-radius: 15px; z-index: 2000;
            pointer-events: none; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 30px rgba(0,0,0,0.6); width: 85%; max-width: 350px; box-sizing: border-box;
        }
        #skill-cutin.show { transform: translate(-50%, -50%) scale(1); }

        #my-skill-status {
            position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); 
            padding: 8px 12px; border-radius: 15px; font-size: 11px; border: 1px solid var(--accent); z-index: 1000;
            display: none; text-align: left; max-width: 140px;
        }

        .card { 
            display: inline-block; width: 58px; height: 85px; background: var(--card-white); color: #333;
            border-radius: 8px; margin: 3px; line-height: 85px; font-size: 20px; font-weight: bold;
            border: 2px solid #000; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer; transition: 0.2s;
        }
        .card:not(.turn-highlight) { opacity: 0.4; transform: scale(0.9); }
        .turn-highlight { border: 3px solid var(--accent); box-shadow: 0 0 10px var(--accent); opacity: 1 !important; transform: translateY(-5px); }
        
        .skill-card { width: 100px; padding: 8px; background: #fff; color: #333; border-radius: 10px; border: 3px solid #ccc; cursor: pointer; margin: 4px; display: inline-block; vertical-align: top; }
        .skill-card.selected { border-color: var(--accent); background: #fffbe6; transform: scale(1.05); }

        .screen { display: none; }
        .active { display: block; }
        #table-card { transform: scale(1.1); background: #ffeb3b; margin: 15px auto; opacity: 1 !important; }
        button { padding: 12px 20px; font-size: 16px; border-radius: 8px; border: none; background: #e67e22; color: white; cursor: pointer; margin: 5px; }
        button:disabled { background: #777; opacity: 0.5; }
        
        .host-config { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px auto; max-width: 300px; }
    </style>
</head>
<body>

    <div id="skill-cutin">ã‚¹ã‚­ãƒ«ç™ºå‹•ï¼</div>

    <div id="my-skill-status">
        ğŸ›¡ï¸ <span id="status-skill-name" style="color: var(--accent); font-weight: bold;">---</span><br>
        <span id="status-skill-desc" style="font-size: 9px; color: #ccc;"></span>
    </div>

    <div id="login-screen" class="screen active">
        <h1>ğŸƒ ãƒŸãƒ‹å¤§å¯Œè±ª</h1>
        <input type="text" id="user-name" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="8"><br>
        <p style="font-size:14px;">ã€ã‚¹ã‚­ãƒ«ã‚’é¸æŠã€‘</p>
        <div id="skill-list"></div>
        <button onclick="checkRole()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>

    <div id="wait-screen" class="screen">
        <h2>å¾…æ©Ÿä¸­...</h2>
        <div id="qr-area" style="display:flex; justify-content:center; margin:15px;"></div>
        
        <div id="host-controls" style="display:none;" class="host-config">
            <p style="margin:0 0 10px 0; font-size:14px;">é…ã‚‹æšæ•°: <span id="hand-size-val">6</span>æš</p>
            <input type="range" id="hand-size-slider" min="4" max="9" value="6" oninput="document.getElementById('hand-size-val').innerText=this.value" style="width:100%;">
            <button id="start-btn" onclick="startGame()" style="width:100%; margin-top:10px;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>
        
        <p id="player-list" style="font-size:14px;"></p>
    </div>

    <div id="play-screen" class="screen">
        <div id="timer-display" style="color:#ff6b6b; font-weight:bold; height:25px; margin-top: 45px; font-size:14px;"></div>
        <div id="table-card" class="card">ãƒ¼</div>
        <div id="turn-info" style="margin:8px; font-size:14px; font-weight:bold;"></div>
        <div id="pass-hint" style="font-size: 10px; color: #ffeb3b; height: 14px; margin-bottom:5px;"></div>
        <hr>
        <div id="my-hand"></div><br>
        <button id="pass-btn" onclick="passTurn()">ãƒ‘ã‚¹ã™ã‚‹</button>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ‰ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸ‰</h1>
        <div id="ranking-list" style="font-size:18px; line-height: 2.2;"></div>
        <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <button onclick="adminReset()" style="position:fixed; bottom:5px; right:5px; opacity:0.1; font-size:10px; background:#000; color:#fff;">ãƒªã‚»ãƒƒãƒˆ</button>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAa1CZBgLYViSMKhg-9D33EZUQwXENFwzo",
        authDomain: "game-496d3.firebaseapp.com",
        projectId: "game-496d3",
        storageBucket: "game-496d3.firebasestorage.app",
        messagingSenderId: "32461027881",
        appId: "1:32461027881:web:06b438a0e2924a2e6b7a38",
        measurementId: "G-HRFJXD28LB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomRef = db.ref('mini_daifugo/game');

    let myId = Math.random().toString(32).substring(2);
    let myName = "";
    let mySkill = "none";
    let isHost = false;
    let kickTimer;
    let lastOutCount = 0;

    const SKILLS_DATA = [
        { id: "none", name: "ä¿ºã¯å¼·ã„ãœ", desc: "å®ŸåŠ›ã®ã¿ã§æˆ¦ã†ã€‚" },
        { id: "eightMaster", name: "8åˆ‡ã‚Šè·äºº", desc: "8ã§å ´ã‚’æµã™ã€‚" },
        { id: "curse", name: "å¾©è®ã®å‘ªã„", desc: "ãƒ‘ã‚¹æ™‚40%ã§å…¨å“¡+1æšã€‚" },
        { id: "greed", name: "å¼·æ¬²ãªå£º", desc: "èª°ã‹ãŒã‚ãŒã‚‹ã¨æ‰‹æœ­-1æšã€‚" },
        { id: "antiTwo", name: "ä¸‹å…‹ä¸Šã®è‹±é›„", desc: "3ã§2ã‚’å€’ã›ã‚‹ã€‚" },
        { id: "lucky", name: "å¹¸é‹ã®å®ˆè­·", desc: "ãƒ‘ã‚¹æ™‚20%ã§æ‰‹æœ­-1æšã€‚" }
    ];

    function initSkillUI() {
        const container = document.getElementById('skill-list');
        SKILLS_DATA.forEach(skill => {
            const div = document.createElement('div');
            div.className = 'skill-card' + (skill.id === "none" ? ' selected' : '');
            div.innerHTML = `<span style="font-weight:bold; font-size:12px;">${skill.name}</span><br><span style="font-size:9px; color:#666;">${skill.desc}</span>`;
            div.onclick = () => {
                mySkill = skill.id;
                document.querySelectorAll('.skill-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
            };
            container.appendChild(div);
        });
    }
    initSkillUI();

    function showSkillEffect(text) {
        const el = document.getElementById('skill-cutin');
        el.innerText = text; el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 1500);
    }

    async function checkRole() {
        myName = document.getElementById('user-name').value || "ãªãªã—";
        const snap = await roomRef.get();
        const data = snap.val();
        if (!data || data.state === 'finished' || !data.state) {
            isHost = true;
            await roomRef.set({ state: 'waiting', tableCard: 0, winners: [], players: {}, lastSkill: "" });
            new QRCode(document.getElementById("qr-area"), window.location.href);
            document.getElementById('host-controls').style.display = "block";
        }
        joinGame();
    }

    function joinGame() {
        roomRef.child('players').child(myId).set({ name: myName, hand: [0], skill: mySkill, isOut: false });
        roomRef.child('players').child(myId).onDisconnect().remove();
        if (isHost) roomRef.onDisconnect().remove();

        document.getElementById('login-screen').classList.remove('active');
        document.getElementById('wait-screen').classList.add('active');

        roomRef.on('value', (snap) => {
            const data = snap.val();
            if (!data || !data.players) return;
            const players = data.players;
            const winners = data.winners || [];

            if (data.lastEffectId !== this.prevEffectId && data.lastSkill) {
                showSkillEffect(data.lastSkill);
                this.prevEffectId = data.lastEffectId;
            }

            if (mySkill === 'greed' && winners.length > lastOutCount && players[myId] && !players[myId].isOut) {
                const myHand = [...(players[myId].hand || [])];
                if (myHand.length > 0) {
                    myHand.splice(0, 1);
                    roomRef.child('players').child(myId).update({ hand: myHand });
                    roomRef.update({ lastSkill: `å¼·æ¬²ãªå£ºï¼ (${myName})`, lastEffectId: Math.random() });
                    if (myHand.length === 0) handleWin(data);
                }
            }
            lastOutCount = winners.length;

            document.getElementById('player-list').innerText = "å‚åŠ è€…: " + Object.keys(players).map(k => k === myId ? players[k].name + " (è‡ªåˆ†)" : players[k].name).join(", ");
            
            if (data.state === 'playing') {
                document.getElementById('my-skill-status').style.display = "block";
                const s = SKILLS_DATA.find(sd => sd.id === mySkill);
                document.getElementById('status-skill-name').innerText = s.name;
                document.getElementById('status-skill-desc').innerText = s.desc;
                if (players[myId] && players[myId].isOut) {
                    document.getElementById('wait-screen').classList.remove('active');
                    document.getElementById('play-screen').classList.add('active');
                    document.getElementById('turn-info').innerText = "ã‚ãŒã‚Šã¾ã—ãŸï¼è¦³æˆ¦ä¸­...";
                    document.getElementById('my-hand').innerHTML = "";
                    document.getElementById('pass-btn').disabled = true;
                } else {
                    showPlayScreen(data);
                }
            }
            if (data.state === 'finished') {
                document.getElementById('my-skill-status').style.display = "none";
                showResultScreen(winners);
            }
        });
    }

    function startGame() {
        const handSize = parseInt(document.getElementById('hand-size-slider').value);
        roomRef.child('players').once('value', (snap) => {
            const players = snap.val();
            const ids = Object.keys(players);
            if (ids.length < 2) { alert("2äººä»¥ä¸Šå¿…è¦ã§ã™"); return; }
            
            // â˜… é…å¸ƒãƒ­ã‚¸ãƒƒã‚¯ï¼šãƒ‡ãƒƒã‚­ã‚’ä½¿ã‚ãšã€å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°å€¤ã‚’ç”Ÿæˆ
            ids.forEach(id => {
                let randomHand = [];
                for (let i = 0; i < handSize; i++) {
                    randomHand.push(Math.floor(Math.random() * 13) + 1);
                }
                randomHand.sort((a, b) => a - b);
                roomRef.child('players').child(id).update({ hand: randomHand, isOut: false });
            });
            roomRef.update({ state: 'playing', tableCard: 0, turnPlayer: ids[0], lastShooter: "", winners: [], lastSkill: `${handSize}æšãšã¤ã§é–‹å§‹ï¼`, lastEffectId: Math.random() });
        });
    }

    function canPlayAny(hand, top) {
        return hand.some(num => {
            if (top === 0) return true;
            if (top === 2 && num === 3 && mySkill === 'antiTwo') return true;
            if (num === 2 && top !== 2) return true;
            if (num !== 2 && getRank(num) > getRank(top)) return true;
            return false;
        });
    }

    function showPlayScreen(data) {
        document.getElementById('wait-screen').classList.remove('active');
        document.getElementById('play-screen').classList.add('active');
        document.getElementById('table-card').innerText = toDisp(data.tableCard);
        const isMyTurn = (data.turnPlayer === myId);
        document.getElementById('turn-info').innerText = isMyTurn ? "â˜… ã‚ãªãŸã®ç•ª â˜…" : `${data.players[data.turnPlayer]?.name}ã•ã‚“ã®ç•ª`;
        
        const myHand = data.players[myId].hand || [];
        const top = data.tableCard || 0;
        const canIPlay = canPlayAny(myHand, top);
        const passBtn = document.getElementById('pass-btn');
        const passHint = document.getElementById('pass-hint');

        if (isMyTurn) {
            startTimer();
            if (canIPlay) { passBtn.disabled = true; passHint.innerText = "å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™"; } 
            else { passBtn.disabled = false; passHint.innerText = "å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“"; }
        } else {
            stopTimer(); passBtn.disabled = true; passHint.innerText = "";
        }

        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = "";
        myHand.forEach((num, idx) => {
            const c = document.createElement('div');
            const isAnti = (top === 2 && num === 3 && mySkill === 'antiTwo');
            const can = isMyTurn && (top === 0 || isAnti || (num === 2 && top !== 2) || (num !== 2 && getRank(num) > getRank(top)));
            c.className = 'card' + (can ? ' turn-highlight' : '');
            c.innerText = toDisp(num);
            c.onclick = () => {
                if(can) {
                    if(isAnti) roomRef.update({ lastSkill: `ä¸‹å…‹ä¸Šï¼ (${myName})`, lastEffectId: Math.random() });
                    playCard(num, idx, myHand);
                }
            };
            handDiv.appendChild(c);
        });
    }

    function playCard(num, idx, hand) {
        roomRef.once('value', (snap) => {
            const data = snap.val();
            hand.splice(idx, 1);
            let nextCard = num; let nextShooter = myId; let nextId;
            if (mySkill === "eightMaster" && num === 8) {
                roomRef.update({ lastSkill: `8åˆ‡ã‚Šï¼ (${myName})`, lastEffectId: Math.random() });
                nextId = myId; nextCard = 0; nextShooter = "";
            } else { nextId = getNextPlayerId(data.players, myId); }
            if (hand.length === 0) handleWin(data, nextId, nextCard, nextShooter);
            else {
                roomRef.child('players').child(myId).update({ hand: hand });
                roomRef.update({ tableCard: nextCard, turnPlayer: nextId, lastShooter: nextShooter });
            }
        });
    }

    function handleWin(data, nextId, nextCard, nextShooter) {
        const winners = data.winners || []; winners.push(myName);
        const activePlayers = Object.keys(data.players).filter(id => id !== myId && !data.players[id].isOut);
        if (activePlayers.length <= 1) {
            if (activePlayers.length === 1) winners.push(data.players[activePlayers[0]].name);
            roomRef.child('players').child(myId).update({ hand: [], isOut: true });
            roomRef.update({ winners: winners, state: 'finished' });
        } else {
            if (!nextId) nextId = getNextPlayerId(data.players, myId); 
            roomRef.child('players').child(myId).update({ hand: [], isOut: true });
            roomRef.update({ winners: winners, turnPlayer: nextId, tableCard: nextCard || 0, lastShooter: nextShooter || "" });
        }
    }

    function passTurn() {
        roomRef.once('value', (snap) => {
            const data = snap.val();
            const myHand = [...(data.players[myId].hand || [])];
            if (mySkill === "curse") {
                if (Math.random() < 0.4) {
                    roomRef.update({ lastSkill: `å‘ªã„æˆåŠŸï¼ (${myName})`, lastEffectId: Math.random() });
                    Object.keys(data.players).forEach(pId => {
                        if (pId !== myId && !data.players[pId].isOut) {
                            const h = [...(data.players[pId].hand || []), Math.floor(Math.random() * 13) + 1].sort((a,b)=>a-b);
                            roomRef.child('players').child(pId).update({ hand: h });
                        }
                    });
                } else { roomRef.update({ lastSkill: `å‘ªã„å¤±æ•—... (${myName})`, lastEffectId: Math.random() }); }
            }
            if (mySkill === "lucky" && Math.random() < 0.2 && myHand.length > 0) {
                myHand.splice(0, 1);
                roomRef.child('players').child(myId).update({ hand: myHand });
                roomRef.update({ lastSkill: `å¹¸é‹ç™ºå‹•ï¼ (${myName})`, lastEffectId: Math.random() });
                if (myHand.length === 0) { handleWin(data); return; }
            }
            const nextId = getNextPlayerId(data.players, myId);
            if (nextId === data.lastShooter) roomRef.update({ tableCard: 0, turnPlayer: nextId, lastShooter: "" });
            else roomRef.update({ turnPlayer: nextId });
        });
    }

    function getNextPlayerId(players, cId) {
        const ids = Object.keys(players);
        let idx = ids.indexOf(cId);
        for (let i = 1; i < ids.length; i++) {
            let nextId = ids[(idx + i) % ids.length];
            if (players[nextId] && !players[nextId].isOut) return nextId;
        }
        return cId; 
    }

    function startTimer() { stopTimer(); kickTimer = setTimeout(() => { passTurn(); roomRef.child('players').child(myId).remove(); location.reload(); }, 45000); }
    function stopTimer() { clearTimeout(kickTimer); }
    function showResultScreen(winners) {
        document.getElementById('play-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        document.getElementById('ranking-list').innerHTML = winners.map((name, i) => `<div>${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'ğŸ–ï¸'} ${i+1}ä½: ${name}</div>`).join("");
    }
    function toDisp(num) { const map = { 1: 'A', 11: 'J', 12: 'Q', 13: 'K', 0: 'ãƒ¼' }; return map[num] || num; }
    function getRank(num) { return num === 1 ? 14 : num === 2 ? 15 : num; }
    function adminReset() { if (prompt("PASS") === "1204") roomRef.remove().then(() => location.reload()); }
</script>
</body>
</html>
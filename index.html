<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŸãƒ‹å¤§å¯Œè±ª - Mini Daifugo</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a4a2e; --card-white: #fdfdfd; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background: var(--bg-color); color: white; margin: 0; padding: 20px; }
        
        /* è‡ªä½œã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ã“ã“ï¼ */
        .card { 
            display: inline-block; width: 60px; height: 90px; 
            background: var(--card-white); color: #333;
            border-radius: 10px; margin: 5px; line-height: 90px; 
            font-size: 28px; font-weight: bold; border: 2px solid #000;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5); cursor: pointer;
            transition: transform 0.1s;
        }
        .card:active { transform: scale(1.1); }
        
        .screen { display: none; }
        .active { display: block; }
        #qr-area img { margin: 20px auto; border: 10px solid white; }
        input { padding: 10px; font-size: 18px; border-radius: 5px; border: none; margin-bottom: 10px; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; border-radius: 5px; border: none; background: #f39c12; color: white; font-weight: bold; }
        #winner-screen { font-size: 40px; color: gold; text-shadow: 2px 2px 4px #000; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>ğŸƒ ãƒŸãƒ‹å¤§å¯Œè±ª</h1>
        <input type="text" id="user-name" placeholder="åå‰ã‚’å…¥ã‚Œã¦ã­" maxlength="8"><br>
        <button onclick="checkRole()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>

    <div id="wait-screen" class="screen">
        <h2 id="wait-msg">å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™...</h2>
        <div id="qr-area"></div>
        <p id="player-list">å‚åŠ è€…: 0äºº</p>
        <button id="start-btn" class="hidden" style="display:none;" onclick="startGame()">å…¨å“¡æƒã£ãŸï¼é–‹å§‹</button>
    </div>

    <div id="play-screen" class="screen">
        <p>å ´ã®ã‚«ãƒ¼ãƒ‰</p>
        <div id="table-card" class="card" style="background: #ffeb3b;">ãƒ¼</div>
        <hr>
        <div id="my-hand-area">
            <p>ã‚ãªãŸã®æ‰‹æœ­</p>
            <div id="my-hand"></div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ‰ çµæœç™ºè¡¨ ğŸ‰</h1>
        <div id="winner-name"></div>
        <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
    </div>

    <script>
        // --- Firebaseè¨­å®š (ã“ã“ã‚’æ›¸ãæ›ãˆï¼) ---
        const firebaseConfig = {
        apiKey: "AIzaSyAa1CZBgLYViSMKhg-9D33EZUQwXENFwzo",
        authDomain: "game-496d3.firebaseapp.com",
        projectId: "game-496d3",
        storageBucket: "game-496d3.firebasestorage.app",
        messagingSenderId: "32461027881",
        appId: "1:32461027881:web:06b438a0e2924a2e6b7a38",
        measurementId: "G-HRFJXD28LB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const roomRef = db.ref('mini_daifugo/game');

        let myId = Math.random().toString(32).substring(2);
        let myName = "";
        let isHost = false;
        // --- è¨­å®šå€¤ ---
        const WARNING_TIME = 30 * 1000; // 30ç§’ã§è­¦å‘Š
        const KICK_TIME = 45 * 1000;    // 45ç§’ã§å¼·åˆ¶é€€å‡º
        let inactivityTimer; // è­¦å‘Šç”¨
        let kickTimer;       // é€€å‡ºç”¨

        // --- 1. æ”¾ç½®é˜²æ­¢ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•° ---
        function startTurnTimer() {
            stopTurnTimer(); // äºŒé‡èµ·å‹•é˜²æ­¢

            // 30ç§’å¾Œã®è­¦å‘Š
            inactivityTimer = setTimeout(() => {
                alert("ã€è­¦å‘Šã€‘ã‚ãªãŸã®ç•ªã§ã™ï¼ã‚ã¨15ç§’ã§å¼·åˆ¶é€€å‡ºã«ãªã‚Šã¾ã™ã€‚");
            }, WARNING_TIME);

            // 45ç§’å¾Œã®å¼·åˆ¶é€€å‡º
            kickTimer = setTimeout(() => {
                alert("æ™‚é–“åˆ‡ã‚Œã®ãŸã‚ã€å¼·åˆ¶é€€å‡ºã¨ãªã‚Šã¾ã—ãŸã€‚");
                disconnectUser();
            }, KICK_TIME);
        }

        // --- 2. ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹é–¢æ•° ---
        function stopTurnTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(kickTimer);
        }

        // --- 3. å¼·åˆ¶é€€å‡ºå‡¦ç† ---
        function disconnectUser() {
            roomRef.child('players').child(myId).remove();
            // éƒ¨å±‹ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆèª°ã‚‚ã„ãªããªã£ãŸå ´åˆãªã©ã®ãŸã‚ï¼‰
            roomRef.update({ state: 'finished', winners: "æ”¾ç½®ã«ã‚ˆã‚‹çµ‚äº†" });
            location.reload(); 
        }

        // --- 4. ã‚²ãƒ¼ãƒ ç”»é¢æ›´æ–°ã®ç›£è¦–ï¼ˆã“ã“ãŒè‚ï¼ï¼‰ ---
        roomRef.on('value', (snap) => {
            const data = snap.val();
            if (!data) return;

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆç­‰ã®æ›´æ–°ï¼ˆçœç•¥ï¼‰
            
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®åˆ¤å®š
            if (data.state === 'playing') {
                showPlayScreen(data);
                
                // Firebaseã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã€Œç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã€ãŒè‡ªåˆ†ã‹ã©ã†ã‹
                if (data.turnPlayer === myId) {
                    console.log("ã‚ãªãŸã®ç•ªã§ã™ã€‚ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹");
                    startTurnTimer();
                } else {
                    console.log("ç›¸æ‰‹ã®ç•ªã§ã™ã€‚ã‚¿ã‚¤ãƒãƒ¼åœæ­¢");
                    stopTurnTimer();
                }
            }
            
            if (data.state === 'finished') {
                stopTurnTimer();
                showResultScreen(data.winners);
            }
        });

        async function checkRole() {
            myName = document.getElementById('user-name').value || "ãªãªã—";
            
            // Firebaseã®ã€Œéƒ¨å±‹ã®çŠ¶æ…‹ã€ã‚’ä¸€åº¦ã ã‘èª­ã¿å–ã‚‹
            const snap = await roomRef.child('state').get();
            const currentState = snap.val();

            // éƒ¨å±‹ãŒã€Œå­˜åœ¨ã—ãªã„ã€ã‹ã€Œçµ‚äº†ï¼ˆfinishedï¼‰ã€ã—ã¦ã„ã‚‹æ™‚ã ã‘è¦ªã«ãªã‚Œã‚‹
            if (!snap.exists() || currentState === 'finished') {
                isHost = true;
                // éƒ¨å±‹ã‚’ã€Œå¾…æ©Ÿä¸­ã€ã«è¨­å®š
                await roomRef.set({ 
                    state: 'waiting', 
                    tableCard: 0, 
                    winners: "",
                    players: {} // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                });
                // è¦ªæ©Ÿå°‚ç”¨ï¼šQRã‚³ãƒ¼ãƒ‰ã¨é–‹å§‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                new QRCode(document.getElementById("qr-area"), window.location.href);
                document.getElementById('start-btn').style.display = "inline-block";
                document.getElementById('wait-msg').innerText = "ã‚ãªãŸã¯ã€è¦ªæ©Ÿã€‘ã§ã™ã€‚å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            } else {
                // ã™ã§ã«èª°ã‹ãŒè¦ªãªã‚‰ã€è‡ªåˆ†ã¯è‡ªå‹•çš„ã«å­æ©Ÿã«ãªã‚‹
                isHost = false;
                document.getElementById('wait-msg').innerText = "ã€å­æ©Ÿã€‘ã¨ã—ã¦å‚åŠ ã—ã¾ã—ãŸã€‚é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            }
            
            joinGame();
        }

        function joinGame() {
            roomRef.child('players').child(myId).set({ name: myName, hand: [] });
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('wait-screen').classList.add('active');

            roomRef.on('value', (snap) => {
                const data = snap.val();
                if (!data) return;

                const pKeys = Object.keys(data.players || {});
                document.getElementById('player-list').innerText = "å‚åŠ è€…: " + pKeys.map(k => data.players[k].name).join(", ");

                if (data.state === 'playing') showPlayScreen(data);
                if (data.state === 'finished') showResultScreen(data.winners);
            });
        }

        function startGame() {
            roomRef.child('players').once('value', (snap) => {
                const players = snap.val();
                for (let id in players) {
                    let hand = [];
                    for(let i=0; i<6; i++) hand.push(Math.floor(Math.random() * 13) + 1);
                    roomRef.child('players').child(id).update({ hand: hand });
                }
                roomRef.update({ state: 'playing', tableCard: 0 });
            });
        }

        function showPlayScreen(data) {
            document.getElementById('wait-screen').classList.remove('active');
            document.getElementById('play-screen').classList.add('active');
            document.getElementById('table-card').innerText = data.tableCard || "ãƒ¼";

            const myData = data.players[myId];
            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = "";
            (myData.hand || []).forEach((num, idx) => {
                const c = document.createElement('div');
                c.className = 'card';
                c.innerText = num;
                c.onclick = () => playCard(num, idx, myData.hand);
                handDiv.appendChild(c);
            });
        }

        function playCard(num, idx, hand) {
            roomRef.child('tableCard').once('value', (snap) => {
                const top = snap.val() || 0;
                
                // --- ã“ã“ã‹ã‚‰åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
                let canPlay = false;

                if (top === 0) {
                    // å ´ãŒç©ºãªã‚‰ä½•ã§ã‚‚å‡ºã›ã‚‹
                    canPlay = true;
                } else if (top === 2 && num === 3) {
                    // ã€ä¸‹å…‹ä¸Šã€‘å ´ãŒ 2 ã§ã€è‡ªåˆ†ãŒå‡ºã™ã®ãŒ 3 ãªã‚‰å‹ã¦ã‚‹ï¼
                    canPlay = true;
                    console.log("ä¸‹å…‹ä¸ŠæˆåŠŸï¼");
                } else if (top === 2) {
                    // å ´ãŒ 2 ã®æ™‚ã€3 ä»¥å¤–ã¯çµ¶å¯¾ã«å‡ºã›ãªã„
                    canPlay = false;
                } else if (num === 2) {
                    // è‡ªåˆ†ãŒå‡ºã™ã®ãŒ 2 ãªã‚‰ã€å ´ãŒ 2 ä»¥å¤–ï¼ˆã‹ã¤ç©ºã§ãªã„ï¼‰ãªã‚‰ã„ã¤ã§ã‚‚å‡ºã›ã‚‹
                    canPlay = true;
                } else if (num > top) {
                    // é€šå¸¸ãƒ«ãƒ¼ãƒ«ï¼šå ´ã‚ˆã‚Šå¤§ãã„æ•°å­—ãªã‚‰å‡ºã›ã‚‹
                    canPlay = true;
                }
                // --- ã“ã“ã¾ã§åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---

                if (canPlay) {
                    // ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã›ãŸã‚‰æ”¾ç½®ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
                    stopTurnTimer();
                    
                    // æ‰‹æœ­ã‹ã‚‰å‡ºã—ãŸã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
                    hand.splice(idx, 1);
                    
                    // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¿ãƒ¼ãƒ³ã‚’å›ã™ï¼ˆâ€»1ï¼‰
                    const nextPlayerId = getNextPlayerId(); 
                    
                    // Firebaseã‚’æ›´æ–°
                    roomRef.update({ 
                        tableCard: num,
                        turnPlayer: nextPlayerId 
                    });
                    roomRef.child('players').child(myId).update({ hand: hand });
                    
                    // ã‚ãŒã‚Šåˆ¤å®š
                    if (hand.length === 0) {
                        roomRef.update({ state: 'finished', winners: myName });
                    }
                } else {
                    alert("ãã®ã‚«ãƒ¼ãƒ‰ã¯å‡ºã›ã¾ã›ã‚“ï¼");
                }
            });
        }

        function showResultScreen(winner) {
            document.getElementById('play-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            document.getElementById('winner-name').innerHTML = `<h2>ğŸ‘‘ å„ªå‹ ğŸ‘‘</h2><p style="font-size:50px;">${winner}</p>`;
        }
    </script>
</body>
</html>
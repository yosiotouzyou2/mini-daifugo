<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŸãƒ‹å¤§å¯Œè±ª - å®Œå…¨ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a4a2e; --card-white: #fdfdfd; }
        body { font-family: sans-serif; text-align: center; background: var(--bg-color); color: white; margin: 0; padding: 20px; overflow-x: hidden; }
        .card { 
            display: inline-block; width: 65px; height: 95px; 
            background: var(--card-white); color: #333;
            border-radius: 8px; margin: 5px; line-height: 95px; 
            font-size: 24px; font-weight: bold; border: 2px solid #000;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer;
        }
        .screen { display: none; }
        .active { display: block; }
        #table-card { transform: scale(1.2); background: #ffeb3b; margin: 20px auto; }
        .turn-highlight { border: 4px solid #f1c40f; box-shadow: 0 0 20px #f1c40f; }
        button { padding: 12px 24px; font-size: 16px; border-radius: 5px; border: none; background: #e67e22; color: white; cursor: pointer; margin-top: 10px; }
        #timer-display { font-size: 20px; color: #ff6b6b; font-weight: bold; height: 30px; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>ğŸƒ ãƒŸãƒ‹å¤§å¯Œè±ª</h1>
        <input type="text" id="user-name" placeholder="åå‰" style="padding:10px; font-size:18px;"><br>
        <button onclick="checkRole()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
    </div>

    <div id="wait-screen" class="screen">
        <h2 id="wait-msg">æ¥ç¶šä¸­...</h2>
        <div id="qr-area"></div>
        <p id="player-list">å‚åŠ è€…: å¾…æ©Ÿä¸­...</p>
        <button id="start-btn" style="display:none;" onclick="startGame()">å…¨å“¡æƒã£ãŸï¼é–‹å§‹</button>
    </div>

    <div id="play-screen" class="screen">
        <div id="timer-display"></div>
        <p>ã€å ´ã®ã‚«ãƒ¼ãƒ‰ã€‘</p>
        <div id="table-card" class="card">ãƒ¼</div>
        <div id="turn-info" style="margin:10px; font-weight:bold;"></div>
        <hr>
        <div id="my-hand"></div>
        <br>
        <button id="pass-btn" onclick="passTurn()">ãƒ‘ã‚¹ã™ã‚‹</button>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ‰ å„ªå‹ ğŸ‰</h1>
        <div id="winner-name" style="font-size:40px; color:gold;"></div>
        <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <button onclick="adminReset()" style="position:fixed; bottom:5px; right:5px; opacity:0.3; font-size:10px; background:#000; color:#fff;">ç®¡ç†è€…ãƒªã‚»ãƒƒãƒˆ</button>

    <script>
        // --- Firebase è¨­å®šï¼ˆè‡ªåˆ†ã®ã‚‚ã®ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰ ---
        const firebaseConfig = {
            apiKey: "AIzaSyAa1CZBgLYViSMKhg-9D33EZUQwXENFwzo",
            authDomain: "game-496d3.firebaseapp.com",
            projectId: "game-496d3",
            storageBucket: "game-496d3.firebasestorage.app",
            messagingSenderId: "32461027881",
            appId: "1:32461027881:web:06b438a0e2924a2e6b7a38",
            measurementId: "G-HRFJXD28LB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const roomRef = db.ref('mini_daifugo/game');

        let myId = Math.random().toString(32).substring(2);
        let myName = "";
        let isHost = false;
        let inactivityTimer, kickTimer;

        // --- 1. è¦ªæ©Ÿãƒ»å­æ©Ÿã®è‡ªå‹•åˆ¤å®š ---
        async function checkRole() {
            myName = document.getElementById('user-name').value || "ãªãªã—";
            const snap = await roomRef.get();
            const data = snap.val();

            if (!data || data.state === 'finished' || !data.state) {
                isHost = true;
                await roomRef.set({ 
                    state: 'waiting', tableCard: 0, winners: "", 
                    lastUpdate: Date.now(), players: {} 
                });
                new QRCode(document.getElementById("qr-area"), window.location.href);
                document.getElementById('start-btn').style.display = "inline-block";
                document.getElementById('wait-msg').innerText = "ã‚ãªãŸã¯ã€è¦ªæ©Ÿã€‘ã§ã™";
            } else {
                isHost = false;
                document.getElementById('wait-msg').innerText = "ã€å­æ©Ÿã€‘ã¨ã—ã¦å‚åŠ ä¸­...";
            }
            joinGame();
        }

        function joinGame() {
            roomRef.child('players').child(myId).set({ name: myName, hand: [0] });
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('wait-screen').classList.add('active');

            roomRef.on('value', (snap) => {
                const data = snap.val();
                if (!data) return;
                
                const pKeys = Object.keys(data.players || {});
                document.getElementById('player-list').innerText = "å‚åŠ è€…: " + pKeys.map(k => data.players[k].name).join(", ");

                if (data.state === 'playing') showPlayScreen(data);
                if (data.state === 'finished') showResultScreen(data.winners);
            });
        }

        // --- 2. ã‚²ãƒ¼ãƒ é–‹å§‹ (è¦ªæ©Ÿã®ã¿) ---
        function startGame() {
            roomRef.child('players').once('value', (snap) => {
                const players = snap.val();
                const ids = Object.keys(players);
                
                // 1. å…¨ã‚«ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆ(1~13ã‚’4æšãšã¤)ã‚’ä½œã‚‹
                let deck = [];
                for (let i = 1; i <= 13; i++) {
                    for (let j = 0; j < 4; j++) deck.push(i);
                }
                
                // 2. ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆæœ¬ç‰©ã®ãƒˆãƒ©ãƒ³ãƒ—ã®ã‚ˆã†ã«æ··ãœã‚‹ï¼‰
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }

                // 3. é †ç•ªã«é…ã‚‹
                ids.forEach((id) => {
                    let hand = deck.splice(0, 6); // 1äººã«6æš
                    hand.sort((a, b) => a - b);   // è¦‹ã‚„ã™ã„ã‚ˆã†ã«æ•°å­—é †ã«ä¸¦ã¹ã‚‹
                    roomRef.child('players').child(id).update({ hand: hand });
                });

                // æœ€åˆã®ã‚¿ãƒ¼ãƒ³ã¨ã€æœ€å¾Œã«ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ãŸäººã‚’ã‚»ãƒƒãƒˆ
                roomRef.update({ 
                    tableCard: num,
                    turnPlayer: nextId,
                    lastShooter: myId // è‡ªåˆ†ãŒæœ€å¾Œã«å‡ºã—ãŸäººã«ãªã‚‹
                });
            });
        }

        // --- 3. ãƒ¡ã‚¤ãƒ³ç”»é¢ã¨ã‚¿ã‚¤ãƒãƒ¼ ---
        function showPlayScreen(data) {
            document.getElementById('wait-screen').classList.remove('active');
            document.getElementById('play-screen').classList.add('active');
            
            // âŒ ã“ã“ã§ num ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
            // âœ… data.tableCard ã‚’ä½¿ã†ã®ãŒæ­£è§£ã§ã™
            const tableCardValue = data.tableCard || 0;
            document.getElementById('table-card').innerText = (tableCardValue === 0) ? "ãƒ¼" : tableCardValue;
            
            const isMyTurn = (data.turnPlayer === myId);
            document.getElementById('turn-info').innerText = isMyTurn ? "â˜… ã‚ãªãŸã®ç•ªã§ã™ â˜…" : `${data.players[data.turnPlayer]?.name}ã•ã‚“ã®ç•ªã§ã™`;
            document.getElementById('pass-btn').disabled = !isMyTurn;

            if (isMyTurn) {
                startTurnTimer();
            } else {
                stopTurnTimer();
            }

            const myData = data.players[myId];
            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = "";
            
            // æ‰‹æœ­ã‚’è¡¨ç¤ºã™ã‚‹ãƒ«ãƒ¼ãƒ—ï¼ˆã“ã“ã¯ num ã§åˆã£ã¦ã„ã¾ã™ï¼‰
            if (myData && myData.hand) {
                myData.hand.forEach((num, idx) => {
                    const c = document.createElement('div');
                    c.className = 'card' + (isMyTurn ? ' turn-highlight' : '');
                    c.innerText = num;
                    c.onclick = () => {
                        if (isMyTurn) playCard(num, idx, myData.hand);
                    };
                    handDiv.appendChild(c);
                });
            }
        }

        // --- 4. ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã™ (ä¸‹å…‹ä¸Šãƒ«ãƒ¼ãƒ«è¾¼) ---
        function playCard(num, idx, hand) {
            roomRef.once('value', (snap) => {
                const data = snap.val();
                const top = data.tableCard || 0;
                let canPlay = false;

                if (top === 0) canPlay = true;
                else if (top === 2 && num === 3) canPlay = true; // ä¸‹å…‹ä¸Š
                else if (top === 2) canPlay = false;
                else if (num === 2) canPlay = true;
                else if (num > top) canPlay = true;

                if (canPlay) {
                    stopTurnTimer();
                    const nextId = getNextPlayerId(data.players, myId);
                    hand.splice(idx, 1);
                    roomRef.update({ tableCard: num, turnPlayer: nextId });
                    roomRef.child('players').child(myId).update({ hand: hand });
                    if (hand.length === 0) roomRef.update({ state: 'finished', winners: myName });
                } else {
                    alert("ãã®ã‚«ãƒ¼ãƒ‰ã¯å‡ºã›ã¾ã›ã‚“ï¼");
                }
            });
        }

        function passTurn() {
            roomRef.once('value', (snap) => {
                const data = snap.val();
                stopTurnTimer();
                
                const nextId = getNextPlayerId(data.players, myId);
                
                // ã‚‚ã—æ¬¡ã®äººãŒã€Œæœ€å¾Œã«ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ãŸäººã€ãªã‚‰ã€å ´ã‚’æµã™
                if (nextId === data.lastShooter) {
                    roomRef.update({ 
                        tableCard: 0, 
                        turnPlayer: nextId,
                        lastShooter: "" // ãƒªã‚»ãƒƒãƒˆ
                    });
                    alert("å…¨å“¡ãƒ‘ã‚¹ã—ãŸã®ã§å ´ãŒæµã‚Œã¾ã—ãŸï¼ã‚ãªãŸã®ç•ªã§ã™ã€‚");
                } else {
                    roomRef.update({ turnPlayer: nextId });
                }
            });
        }

        function getNextPlayerId(players, currentId) {
            const ids = Object.keys(players);
            const idx = ids.indexOf(currentId);
            return ids[(idx + 1) % ids.length];
        }

        // --- 5. ã‚¿ã‚¤ãƒãƒ¼å‡¦ç† (30sè­¦å‘Š / 45sé€€å‡º) ---
        function startTurnTimer() {
            stopTurnTimer();
            document.getElementById('timer-display').innerText = "åˆ¶é™æ™‚é–“: 45ç§’";
            inactivityTimer = setTimeout(() => {
                alert("ã€30ç§’çµŒéã€‘ã‚ã¨15ç§’ã§å¼·åˆ¶é€€å‡ºã§ã™ï¼");
            }, 30000);
            kickTimer = setTimeout(() => {
                alert("æ™‚é–“åˆ‡ã‚Œã§é€€å‡ºã—ã¾ã—ãŸ");
                roomRef.child('players').child(myId).remove();
                location.reload();
            }, 45000);
        }

        function stopTurnTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(kickTimer);
            document.getElementById('timer-display').innerText = "";
        }

        function showResultScreen(winner) {
            document.getElementById('play-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            document.getElementById('winner-name').innerText = winner;
        }

        function adminReset() {
            if (prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰") === "1204") {
                roomRef.remove().then(() => location.reload());
            }
        }
    </script>
</body>
</html>